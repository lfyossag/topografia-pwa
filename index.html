<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#1f3a8a">
  <title>Informe Diario de Topograf√≠a</title>
  <style>
    :root{
      --bg:#f7f8fb; --fg:#0f172a; --muted:#475569; --pri:#1f3a8a; --ok:#0d9488; --err:#b91c1c;
      --card:#ffffff; --bd:#e2e8f0; --bd2:#cbd5e1; --soft:#f1f5f9; --shadow:0 8px 28px rgba(2,6,23,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial; background:var(--bg); color:var(--fg)}
    body.modal-open{overflow:hidden}
    .wrap{max-width:960px;margin:0 auto;padding:16px}
    @media (min-width:1024px){.wrap{padding:24px}}

    .card{background:var(--card); border:1px solid var(--bd); border-radius:16px; box-shadow:var(--shadow)}
    .p-xl{padding:18px}

    .hdr{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    h1{font-size:20px;margin:0}

    .toolbar{display:flex; gap:10px; flex-wrap:wrap}
    .toolbar.right{margin-left:auto}
    button{appearance:none; border:1px solid var(--bd2); background:#fff; color:#0f172a; padding:10px 14px; border-radius:10px; cursor:pointer}
    .btn{background:var(--pri); color:#fff; border-color:transparent}
    .btn-err{background:var(--err); color:#fff; border-color:transparent}
    .btn-ghost{background:#fff}

    .row{display:grid; gap:10px}
    .row.cols-2{grid-template-columns:repeat(2, minmax(0,1fr))}
    @media (max-width:720px){ .row.cols-2{grid-template-columns:1fr} }

    label{font-size:12px;color:var(--muted)}
    input, select, textarea{width:100%; padding:10px 12px; border:1px solid var(--bd2); border-radius:10px; background:#fff; outline:none; font-size:14px}
    input.invalid, select.invalid, textarea.invalid{border-color:var(--err)}
    textarea{resize:vertical; font-family:inherit; min-height:60px;}

    .sep{height:1px; background:var(--bd); margin:12px 0}

    .table-wrap{overflow:auto; border:1px solid var(--bd); border-radius:14px}
    table{width:100%; border-collapse:separate; border-spacing:0}
    th, td{border-bottom:1px solid var(--bd); padding:8px 10px; text-align:left; vertical-align:top; font-size:14px}
    th{position:sticky; top:0; background:var(--soft); z-index:1; font-size:12px; color:var(--muted); border-bottom:1px solid var(--bd2)}
    .num{width:56px}
    .fit{width:80px; white-space:nowrap}
    .coord-col{width:180px; min-width:160px}
    .actions-row{display:flex; gap:4px; justify-content:center; align-items:center}
    .btn-icon{width:30px; height:30px; padding:0; border-radius:6px; display:flex; align-items:center; justify-content:center; cursor:pointer; border:1px solid var(--bd2); background:#fff; transition:all 0.2s; position:relative}
    .btn-icon:hover{transform:translateY(-1px); box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    .btn-icon.edit{color:#3b82f6}
    .btn-icon.edit:hover{background:#eff6ff; border-color:#3b82f6}
    .btn-icon.delete{color:#ef4444}
    .btn-icon.delete:hover{background:#fef2f2; border-color:#ef4444}
    .btn-icon svg{width:14px; height:14px; fill:currentColor}

    .toast{position:fixed; left:50%; transform:translateX(-50%); bottom:14px; background:#111827; color:#fff; padding:10px 12px; border-radius:8px; box-shadow:var(--shadow); display:none}
    .danger{background:#b91c1c}
    .ok{background:#0d9488}

    .status{display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--bd2); background:var(--soft)}

    /* Bot√≥n eliminar foto */
    .photo-card .btn-delete{position:absolute;right:4px;top:4px;width:24px;height:24px;border-radius:4px;background:rgba(255,255,255,0.9);display:flex;align-items:center;justify-content:center;padding:0;cursor:pointer;border:1px solid var(--bd2)}
    .photo-card .btn-delete:hover{background:#fff}
    .photo-card .btn-delete svg{width:14px;height:14px;fill:var(--err)}

    /* ===== Modal ===== */
    .modal-backdrop{position:fixed; inset:0; background:rgba(15,23,42,.4); display:none; align-items:flex-end; z-index:1000}
    .modal{background:#fff; border-radius:16px 16px 0 0; width:100%; max-height:92%; overflow:auto; box-shadow:var(--shadow); border:1px solid var(--bd)}
    .modal .head{padding:14px 16px; border-bottom:1px solid var(--bd); display:flex; justify-content:space-between; align-items:center}
    .modal .body{padding:14px 16px}
    .modal .foot{padding:12px 16px; border-top:1px solid var(--bd); display:flex; justify-content:flex-end; gap:10px}
    @media (min-width:720px){ .modal-backdrop{align-items:center; justify-content:center} .modal{border-radius:16px; max-width:860px} }

    .checks{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .checks label{display:inline-flex; align-items:center; gap:6px}
    .hidden{display:none}

    /* ===== Fotos (solo modal) ===== */
    .photos-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px}
    .photo-card{border:1px solid var(--bd2);border-radius:10px;padding:8px;background:#fff;display:flex;flex-direction:column;gap:6px;position:relative}
    .photo-card img{width:100%;height:90px;object-fit:cover;border-radius:8px;border:1px solid var(--bd)}
    .photo-card .photo-preview{position:relative;display:inline-block;width:100%}
    .photo-card .photo-preview .local-icon{position:absolute;top:8px;left:8px;background:rgba(255,193,7,0.9);color:white;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;font-size:12px;opacity:0.9}
    .photo-row{display:flex;gap:6px;align-items:center}
    .photo-row input[type="text"]{flex:1;min-width:0}
    .badge{display:inline-block;padding:2px 6px;border:1px solid var(--bd2);border-radius:999px;font-size:11px;color:var(--muted)}
    .badge.ok{color:#065f46;border-color:#065f46}
    .badge.warn{color:#a16207;border-color:#a16207}
    .photo-card .desc-input{margin-top:6px;padding-right:34px}
    .btn-link{background:none;border:none;cursor:pointer;padding:4px 8px;border-radius:4px;transition:background 0.2s;font-size:14px}
    .btn-link:hover{background:#f0f0f0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card p-xl">
      <!-- ENCABEZADO -->
      <div class="hdr">
        <h1>INFORME DIARIO DE TOPOGRAF√çA</h1>
        <div class="toolbar right">
          <button class="btn-ghost" id="btnRefreshCatalogs" title="Actualizar listas">Actualizar listas</button>
          <button class="btn-ghost" id="btnSync">Sincronizar</button>
          <span class="status" id="statusChip">Offline</span>
          <button id="btnInstall" class="btn-ghost" style="display:none">Instalar</button>
        </div>
      </div>

      <div class="sep"></div>

      <!-- BOTONES DEL INFORME -->
      <div class="toolbar" id="toolbarInforme">
        <button class="btn-ghost" id="btnNuevo">Nuevo</button>
        <button class="btn" id="btnGuardar">Guardar</button>
        <button class="btn-err" id="btnEliminar" disabled>Eliminar</button>
        <button class="btn-ghost" id="btnGenerarPDF" disabled>Generar Informe</button>
      </div>

      <!-- ENLACE AL PDF GENERADO -->
      <div id="pdfLinkContainer" class="card" style="display: none; margin-top: 12px; padding: 12px; background: #f0f9ff; border-left: 4px solid var(--pri);">
        <div style="display: flex; align-items: center; gap: 10px;">
          <span style="font-weight: bold; color: var(--pri);">üìÑ Informe PDF generado:</span>
          <a id="pdfLink" href="#" target="_blank" style="color: var(--pri); text-decoration: none; font-weight: 500;">Ver PDF</a>
          <button id="btnClosePdfLink" class="btn-ghost" style="margin-left: auto; padding: 4px 8px; font-size: 12px;">‚úï</button>
        </div>
      </div>

      <div class="sep"></div>

      <!-- MENSAJE CAMPOS OBLIGATORIOS -->
      <div style="margin-bottom: 12px; padding: 8px; background: #fefce8; border: 1px solid #facc15; border-radius: 8px; font-size: 12px; color: #713f12;">
        <strong>Nota:</strong> Los campos marcados con <span style="color: #dc2626;">*</span> son obligatorios
      </div>

      <!-- FORM PRINCIPAL (2 columnas) -->
      <div class="row cols-2">
        <div>
          <label>Fecha del informe <span style="color: #dc2626;">*</span></label>
          <input type="date" id="fecha_informe" />
        </div>
        <div>
          <label>Jornada <span style="color: #dc2626;">*</span></label>
          <select id="jornada">
            <option value="diurno">Diurna</option>
            <option value="nocturno">Nocturna</option>
          </select>
        </div>
        <div>
          <label>Frente general de trabajo <span style="color: #dc2626;">*</span></label>
          <select id="frente">
            <option value="Obras Principales">Obras Principales</option>
            <option value="Mantenimiento vial">Mantenimiento vial</option>
          </select>
        </div>
        <div>
          <label>Clima</label>
          <select id="clima">
            <option value="Seco">Seco</option>
            <option value="Lluvias">Lluvias</option>
          </select>
        </div>
      </div>

      <div class="row cols-2" style="margin-top:10px">
        <div>
          <label>Serial equipo de trabajo <span style="color: #dc2626;">*</span></label>
          <select id="equipo_trabajo_id"></select>
        </div>
        <div>
          <label>Top√≥grafo <span style="color: #dc2626;">*</span></label>
          <select id="topografo_id"></select>
        </div>
      </div>

      <div class="row" style="margin-top:6px">
        <div>
          <label>Seleccionar informe</label>
          <select id="selInforme" title="Selecciona un informe"></select>
        </div>
      </div>

      <div class="sep"></div>

      <!-- TRABAJOS -->
      <div class="hdr" style="margin:8px 0; gap:10px">
        <h2 style="margin:0; font-size:16px; color:var(--pri)">Trabajo ejecutado por la comisi√≥n de topograf√≠a</h2>
        <div class="toolbar right">
          <button class="btn" id="btnAddTrabajo">+ Agregar trabajo</button>
          <button class="btn-ghost" id="btnLimpiarTrabajos">Limpiar</button>
        </div>
      </div>

      <div class="table-wrap">
        <table id="tblTrabajos">
          <thead>
            <tr>
              <th class="num">No.</th>
              <th>Contratista</th>
              <th>Lote de trabajo</th>
              <th>Frente espec√≠fico</th>
              <th>Plano de construcci√≥n</th>
              <th class="coord-col">Abscisa Inicial / Final</th>
              <th class="coord-col">Ordenada Inicial / Final</th>
              <th class="coord-col">Elevaci√≥n Inicial / Final</th>
              <th style="width:120px;">Actividad</th>
              <th>Descripci√≥n</th>
              <th class="fit">Acciones</th>
            </tr>
          </thead>
          <tbody id="bodyTrabajos"></tbody>
        </table>
      </div>

    </div>
  </div>

  <!-- MODAL TRABAJO -->
  <div class="modal-backdrop" id="modalBack">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="head">
        <strong id="modalTitle">Agregar trabajo</strong>
        <button class="btn-ghost" id="btnCloseModal">Cerrar</button>
      </div>
      <div class="body">
        <div class="checks" style="margin-bottom:6px">
          <label>Localizaci√≥n:</label>
          <label><input type="checkbox" id="chk_abscisa"> Abscisa</label>
          <label><input type="checkbox" id="chk_ordenada"> Ordenada</label>
          <label><input type="checkbox" id="chk_elevacion"> Elevaci√≥n</label>
        </div>
        <div class="row cols-2">
          <div>
            <label>Contratista <span style="color: #dc2626;">*</span></label>
            <select id="m_contratista">
              <option value="">Seleccione contratista</option>
              <option value="Estyma">Estyma</option>
              <option value="CYS">CYS</option>
              <option value="Provias">Provias</option>
            </select>
          </div>
          <div>
            <label>Lote de trabajo <span style="color: #dc2626;">*</span></label>
            <select id="m_lote_control_id"></select>
          </div>
          <div>
            <label>Frente espec√≠fico <span style="color: #dc2626;">*</span></label>
            <select id="m_lote_trabajo_id"></select>
          </div>
          <div>
            <label>Plano de construcci√≥n (m√°x 50)</label>
            <input id="m_plano_construccion" maxlength="50">
          </div>

          <div class="loc-abscisa hidden">
            <label>Abscisa inicial</label>
            <input id="m_abscisa_inicial" inputmode="decimal">
          </div>
          <div class="loc-abscisa hidden">
            <label>Abscisa final</label>
            <input id="m_abscisa_final" inputmode="decimal">
          </div>

          <div class="loc-ordenada hidden">
            <label>Ordenada inicial</label>
            <input id="m_ordenada_inicial" inputmode="decimal">
          </div>
          <div class="loc-ordenada hidden">
            <label>Ordenada final</label>
            <input id="m_ordenada_final" inputmode="decimal">
          </div>

          <div class="loc-elevacion hidden">
            <label>Elevaci√≥n inicial</label>
            <input id="m_elevacion_inicial" inputmode="decimal">
          </div>
          <div class="loc-elevacion hidden">
            <label>Elevaci√≥n final</label>
            <input id="m_elevacion_final" inputmode="decimal">
          </div>

          <div>
            <label>Actividad <span style="color: #dc2626;">*</span></label>
            <select id="m_actividad">
              <option value="">Seleccione</option>
              <option value="liberacion">Liberaci√≥n</option>
              <option value="chequeo">Chequeo</option>
              <option value="levantamiento">Levantamiento</option>
            </select>
          </div>
          <div style="grid-column:1/-1">
            <label>Descripci√≥n <span style="color: #dc2626;">*</span></label>
            <textarea id="m_descripcion_actividad" rows="3" style="width:100%; padding:10px 12px; border:1px solid var(--bd2); border-radius:10px; background:#fff; outline:none; font-size:14px; resize:vertical; font-family:inherit;"></textarea>
          </div>
          <div>
            <label>Estado actividad</label>
            <select id="m_estado_actividad"></select>
          </div>

          <!-- ===== FOTOS ===== -->
          <div style="grid-column:1/-1">
            <div class="photo-row">
              <label>Fotos (opcionales)</label>
              <input type="file" id="m_fotos_input" accept="image/*" multiple style="margin-left:auto">
            </div>
            <div id="m_fotos_list" class="photos-grid" style="margin-top:8px"></div>
          </div>
          <!-- ===== /FOTOS ===== -->

        </div>
      </div>
      <div class="foot">
        <button class="btn-ghost" id="btnModalCancel">Cancelar</button>
        <button class="btn" id="btnModalSave">Guardar trabajo</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Hecho</div>

  <script>
    /* ===== Endpoints (n8n) ===== */
    const ENDPOINT_DATA = "https://luisyg.app.n8n.cloud/webhook/datos";              // CRUD Sheets
    const ENDPOINT_CATALOGS = "https://luisyg.app.n8n.cloud/webhook/obtener-datos";  // Cat√°logos (GET)
    const ENDPOINT_UPLOAD = "https://luisyg.app.n8n.cloud/webhook/subir-foto";       // Subir fotos (multipart)

    /* ===== Utils ===== */
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const toast = (msg, type) => { const t=$('#toast'); t.textContent=msg; t.className='toast'+(type? ' '+type:''); t.style.display='block'; setTimeout(()=>t.style.display='none', 2200); };
    const todayISO = () => new Date().toISOString().slice(0,10);
    const numberOrNull = v => { if (v===''||v==null) return null; const n=Number(String(v).replace(/,/g,'.')); return Number.isFinite(n)?n:null; };
    const uid = () => `${Date.now().toString(36)}-${Math.random().toString(36).slice(2,10)}`;
    const KEY = (k)=>`topografia_${k}`;
    const db = { get:(k,d)=>{try{return JSON.parse(localStorage.getItem(KEY(k))||JSON.stringify(d));}catch{return d}}, set:(k,v)=>localStorage.setItem(KEY(k), JSON.stringify(v)), del:(k)=>localStorage.removeItem(KEY(k)) };

    // Funciones de formateo para coordenadas
    const formatAbscisa = (value) => {
      if (!value && value !== 0) return '';
      const num = Number(value);
      if (!Number.isFinite(num)) return value;
      
      // Formato K1+456 cuando supera 1000, K0+678 cuando no
      if (num >= 1000) {
        const km = Math.floor(num / 1000);
        const metros = num % 1000;
        return `Abs K${km}+${metros.toString().padStart(3, '0')}`;
      } else {
        // Formato K0+XXX para n√∫meros menores a 1000
        return `Abs K0+${num.toString().padStart(3, '0')}`;
      }
    };
    
    const formatOrdenada = (value) => {
      if (!value && value !== 0) return '';
      return `Ord ${value}`;
    };
    
    const formatElevacion = (value) => {
      if (!value && value !== 0) return '';
      return `Elv ${value}`;
    };

    // Convierte link de Drive "view" a link embebible (uc?export=view)
    function drivePreview(url){
      if(!url) return '';
      // Extraer ID de diferentes formatos de URL de Drive
      let id = null;
      if(url.includes('drive.google.com')){
        const m1 = url.match(/\/d\/([^/]+)/);
        const m2 = url.match(/id=([^&]+)/);
        id = m1 ? m1[1] : (m2 ? m2[1] : null);
      }
      return id ? `https://drive.google.com/uc?export=view&id=${id}` : url;
    }

    /* ===== Estado ===== */
    let trabajosState=[]; let currentId=null;
    let catalogos = { equipos:[], personas:[], informes:[], lotes_control:[], lotes_trabajo:[] };

    function seed(){
      if(!db.get('equipos',null)) db.set('equipos',[]);
      if(!db.get('personas',null)) db.set('personas',[]);
      if(!db.get('lotes_control',null)) db.set('lotes_control',[]);
      if(!db.get('lotes_trabajo',null)) db.set('lotes_trabajo',[]);
      if(!db.get('informes',null)) db.set('informes',[]);
      if(!db.get('outbox',null)) db.set('outbox',[]);
    }

    /* ===== Validaci√≥n ===== */
    function markInvalid(el, invalid){
      if(!el) return;
      el.classList.toggle('invalid', !!invalid);
    }

    function validateInforme(){
      let ok=true;
      const req = [$('#fecha_informe'),$('#jornada'),$('#frente'),$('#equipo_trabajo_id'),$('#topografo_id')];
      for(const el of req){ const invalid = !el.value; markInvalid(el, invalid); if(invalid) ok=false; }
      if(!ok) toast('Completa los campos obligatorios del informe','danger');
      return ok;
    }

    function isFilledNumber(val){ const n = numberOrNull(val); return n!==null; }

    // Recuento de fotos reales (locales + ya subidas)
    function countPhotos(arr){ return (arr||[]).filter(p => p.__local || p.url).length; }

    function validateTrabajoModal(){
      let ok=true;
      const reqBase = [$('#m_contratista'),$('#m_lote_control_id'),$('#m_lote_trabajo_id'),$('#m_actividad'),$('#m_descripcion_actividad')];
      for(const el of reqBase){ const invalid = !el.value || ((el.tagName==='INPUT' || el.tagName==='TEXTAREA') && !el.value.trim()); markInvalid(el, invalid); if(invalid) ok=false; }

      if($('#chk_abscisa').checked){
        const a1=$('#m_abscisa_inicial'), a2=$('#m_abscisa_final');
        const ia1=!isFilledNumber(a1.value), ia2=!isFilledNumber(a2.value);
        markInvalid(a1, ia1); markInvalid(a2, ia2); if(ia1||ia2) ok=false;
      }
      if($('#chk_ordenada').checked){
        const o1=$('#m_ordenada_inicial'), o2=$('#m_ordenada_final');
        const io1=!isFilledNumber(o1.value), io2=!isFilledNumber(o2.value);
        markInvalid(o1, io1); markInvalid(o2, io2); if(io1||io2) ok=false;
      }
      if($('#chk_elevacion').checked){
        const e1=$('#m_elevacion_inicial'), e2=$('#m_elevacion_final');
        const ie1=!isFilledNumber(e1.value), ie2=!isFilledNumber(e2.value);
        markInvalid(e1, ie1); markInvalid(e2, ie2); if(ie1||ie2) ok=false;
      }

      // Las fotos ahora son opcionales - comentamos la validaci√≥n
      // if (countPhotos(__modalPhotos) < 2){ toast('Debes adjuntar al menos 2 fotos','danger'); ok=false; }

      if(!ok) toast('Revisa los campos obligatorios del trabajo','danger');
      return ok;
    }

    // Sincroniza los valores de los inputs de descripci√≥n de fotos con el array __modalPhotos
    function syncPhotoDescriptions() {
      document.querySelectorAll('#m_fotos_list .desc-input').forEach((input, idx) => {
        if (__modalPhotos[idx]) {
          __modalPhotos[idx].desc = input.value;
          __modalPhotos[idx].descripcion_foto = input.value;
        }
      });
    }

    // Sincroniza todas las descripciones de fotos de todos los trabajos antes de guardar
    function syncAllPhotoDescriptions() {
      // Si el modal est√° abierto, sincroniza __modalPhotos
      if (document.body.classList.contains('modal-open')) {
        document.querySelectorAll('#m_fotos_list .desc-input').forEach((input, idx) => {
          if (window.__modalPhotos && window.__modalPhotos[idx]) {
            window.__modalPhotos[idx].desc = input.value;
          }
        });
      }
      // Para cada trabajo, sincroniza las descripciones almacenadas
      if (window.trabajosState) {
        window.trabajosState.forEach(trabajo => {
          if (trabajo.fotos && Array.isArray(trabajo.fotos)) {
            trabajo.fotos.forEach(foto => {
              // Si hay un input visible para esta foto, √∫salo
              const input = document.querySelector(`#m_fotos_list .desc-input[data-foto-id='${foto.id_foto||foto.id}']`);
              if (input) {
                foto.desc = input.value;
                foto.descripcion_foto = input.value;
              } else if (foto.desc) {
                foto.descripcion_foto = foto.desc;
              }
            });
          }
        });
      }
    }

    /* ===== API (DATA) ===== */
    async function dataApi(payload){
      const READ_ACTIONS = new Set(['bootstrap','list_informes','get_informe']);
      if (READ_ACTIONS.has(payload.action)) return localApi(payload);
      
      const online = navigator.onLine && ENDPOINT_DATA;
      console.log(`üåê dataApi - Online: ${online}, Action: ${payload.action}`);
      
      if (online){
        try{
          console.log('üì§ Sending to n8n:', {
            endpoint: ENDPOINT_DATA,
            action: payload.action,
            dataKeys: Object.keys(payload.data || {}),
            trabajosCount: payload.data?.trabajos?.length || 0,
            fotosTotal: (payload.data?.trabajos || []).reduce((n,t) => n + (t.fotos||[]).length, 0)
          });
          
          const res = await fetch(ENDPOINT_DATA, {
            method:'POST', 
            headers:{'Content-Type':'application/json'}, 
            body:JSON.stringify(payload)
          });
          
          if (!res.ok) {
            const errorText = await res.text();
            console.error('‚ùå n8n response error:', res.status, errorText);
            throw new Error(`HTTP ${res.status}: ${errorText}`);
          }
          
          const result = await res.json();
          console.log('‚úÖ n8n response success:', result);
          return result;
        }catch(e){
          console.error('‚ùå dataApi error:', e);
          if (['create_informe','update_informe','delete_informe'].includes(payload.action)){
            console.log('üíæ Guardando en outbox para sincronizaci√≥n posterior');
            const outbox=db.get('outbox',[]); outbox.push(payload); db.set('outbox', outbox);
          }
          console.log('üì± Cayendo a localApi');
          return localApi(payload);
        }
      }
      console.log('üì± Usando localApi (offline)');
      return localApi(payload);
    }

    /* ===== API (CAT√ÅLOGOS) ===== */
    async function catalogsApi(){
      const online = navigator.onLine && ENDPOINT_CATALOGS;
      if (!online) {
        return {equipos: db.get('equipos',[]), personas: db.get('personas',[]), lotes_control: db.get('lotes_control',[]), lotes_trabajo: db.get('lotes_trabajo',[])};
      }
      try{
        const res = await fetch(ENDPOINT_CATALOGS, { method:'GET' });
        if(!res.ok) throw new Error('HTTP '+res.status);
        let json = await res.json();
        if (Array.isArray(json)) json = json[0] || {};
        const equipos = Array.isArray(json.equipos) ? json.equipos : [];
        const personas = Array.isArray(json.personas) ? json.personas : [];
        const lotes_control = Array.isArray(json.lotes_control) ? json.lotes_control : [];
        const lotes_trabajo = Array.isArray(json.lotes_trabajo) ? json.lotes_trabajo : [];
        db.set('equipos', equipos); db.set('personas', personas); db.set('lotes_control', lotes_control); db.set('lotes_trabajo', lotes_trabajo);
        return { equipos, personas, lotes_control, lotes_trabajo };
      }catch(e){
        console.error('catalogsApi error:', e);
        toast('No se pudo actualizar listas','danger');
        return {equipos: db.get('equipos',[]), personas: db.get('personas',[]), lotes_control: db.get('lotes_control',[]), lotes_trabajo: db.get('lotes_trabajo',[])};
      }
    }

    /* ===== API LOCAL ===== */
    function localApi(payload){
      const informes=db.get('informes',[]);
      switch(payload.action){
        case 'bootstrap':
          return Promise.resolve({equipos:db.get('equipos',[]),personas:db.get('personas',[]),informes});
        case 'list_informes':
          return Promise.resolve({informes});
        case 'get_informe':
          return Promise.resolve({record: db.get(`informe_${payload.id}`, null)});
        case 'create_informe': {
          const provided = payload.data?.informe?.id;
          const id = provided || String(Date.now());
          const full={ id, ...payload.data.informe, trabajos:(payload.data.trabajos||[]).map(t=>({...t, id_informe:id})) };
          const minimal={ id, fecha_informe:full.fecha_informe, frente:full.frente, jornada:full.jornada };
          const idx=informes.findIndex(x=>x.id==id);
          if(idx>=0) informes[idx]=minimal; else informes.unshift(minimal);
          db.set('informes',informes); db.set(`informe_${id}`, full);
          return Promise.resolve({id});
        }
        case 'update_informe': {
          const id = payload.id || payload.data?.informe?.id;
          const full={ id, ...payload.data.informe, trabajos: payload.data.trabajos };
          const minimal={ id, fecha_informe:full.fecha_informe, frente:full.frente, jornada:full.jornada };
          const idx=informes.findIndex(x=>x.id==id);
          if(idx>=0) informes[idx]=minimal; else informes.unshift(minimal);
          db.set('informes',informes); db.set(`informe_${id}`, full);
          return Promise.resolve({ok:true});
        }
        case 'delete_informe': {
          const id=payload.id;
          const next=informes.filter(x=>x.id!=id);
          db.set('informes', next); db.del(`informe_${id}`);
          return Promise.resolve({ok:true});
        }
        default: return Promise.resolve({ok:true});
      }
    }

    function mirrorLocal(payload){
      const id = payload?.informe?.id;
      if(!id) return;
      const informes=db.get('informes',[]);
      const minimal={ id, fecha_informe:payload.informe.fecha_informe, frente:payload.informe.frente, jornada:payload.informe.jornada };
      const idx=informes.findIndex(x=>x.id==id);
      if(idx>=0) informes[idx]=minimal; else informes.unshift(minimal);
      db.set('informes', informes);
      const full={ id, ...payload.informe, trabajos: payload.trabajos || [] };
      db.set(`informe_${id}`, full);
    }

    async function trySync(){
      if(!ENDPOINT_DATA){ toast('Sin endpoint configurado'); return; }
      const outbox=db.get('outbox',[]);
      if(outbox.length===0){ toast('No hay cambios pendientes','ok'); return; }
      for(const p of outbox){
        const r=await fetch(ENDPOINT_DATA,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(p)});
        if(!r.ok) throw new Error('Fallo de sincronizaci√≥n');
      }
      db.set('outbox',[]); toast('Sincronizado','ok');
    }

    /* ===== Helpers UI ===== */
    function fmtPair(a,b){ const x=a??''; const y=b??''; return `${x}${(x!==''||y!=='')?' / ':''}${y}`; }
    
    // Funci√≥n especializada para formatear pares de coordenadas con prefijos
    function fmtCoordPair(inicial, final, formatter) {
      const x = inicial != null ? formatter(inicial) : '';
      const y = final != null ? formatter(final) : '';
      return `${x}${(x !== '' || y !== '') ? ' / ' : ''}${y}`;
    }

    function renderTrabajos(){
      const body=$('#bodyTrabajos'); body.innerHTML='';
      trabajosState.forEach((t,i)=>{
        const tr=document.createElement('tr'); tr.dataset.id=t.id;
        tr.innerHTML=`<td class="num"><span class="rownum">${i+1}</span></td>
          <td>${t.contratista||''}</td>
          <td>${t.lote_trabajo||''}</td>
          <td>${t.frente_especifico||''}</td>
          <td>${t.plano_construccion||''}</td>
          <td class="coord-col">${fmtCoordPair(t.abscisa_inicial,t.abscisa_final,formatAbscisa)}</td>
          <td class="coord-col">${fmtCoordPair(t.ordenada_inicial,t.ordenada_final,formatOrdenada)}</td>
          <td class="coord-col">${fmtCoordPair(t.elevacion_inicial,t.elevacion_final,formatElevacion)}</td>
          <td>${t.actividad||''}</td>
          <td>${t.descripcion_actividad||''}</td>
          <td class="fit">
            <div class="actions-row">
              <button class="btn-icon edit" title="Editar trabajo">
                <svg viewBox="0 0 24 24" focusable="false">
                  <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                </svg>
              </button>
              <button class="btn-icon delete" title="Eliminar trabajo">
                <svg viewBox="0 0 24 24" focusable="false">
                  <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                </svg>
              </button>
            </div>
          </td>`;
        tr.querySelector('.btn-icon.edit').addEventListener('click',()=>openTrabajoModal('edit',i,t));
        tr.querySelector('.btn-icon.delete').addEventListener('click',()=>deleteTrabajoById(t.id));
        body.appendChild(tr);
      });
    }

    function optionize(sel, items, valueField, labelField, {placeholder}={}){
      sel.innerHTML='';
      if(placeholder){ const op=document.createElement('option'); op.value=''; op.textContent=placeholder; sel.appendChild(op); }
      for(const it of items){ const op=document.createElement('option'); op.value=it[valueField]; op.textContent=it[labelField]; sel.appendChild(op); }
    }
    function findById(arr, id){ return (arr||[]).find(x => String(x.id)===String(id)) || null; }

    // ====== FOTOS (estado del modal) ======
    // cada item: { localId, __local, __blob, url, desc, status, id_foto }
    let __modalPhotos = [];

    function renderModalPhotos(){
      const wrap = document.getElementById('m_fotos_list');
      wrap.innerHTML = '';
      console.log('üñºÔ∏è Renderizando fotos del modal:', __modalPhotos.map(p => ({
        localId: p.localId,
        isLocal: p.__local,
        hasBlob: !!p.__blob,
        hasPreviewUrl: !!p.previewUrl,
        hasUrl: !!p.url
      })));
      __modalPhotos.forEach(p=>{
        // Determinar la fuente de la imagen
        let src = '';
        if (p.__local && p.__blob) {
          // Para fotos locales, crear ObjectURL si no existe
          if (!p.previewUrl) {
            try { 
              p.previewUrl = URL.createObjectURL(p.__blob); 
              console.log('‚úÖ Preview creado para foto local:', p.localId);
            } catch(e) { 
              console.warn('‚ùå No se pudo crear preview:', e); 
            }
          }
          src = p.previewUrl;
        } else if (!p.__local && p.url) {
          // Para fotos subidas, usar DrivePreview
          src = drivePreview(p.url);
        }
        
        const card = document.createElement('div');
        card.className = 'photo-card';
        card.innerHTML = `
          <div class="photo-preview">
            <img src="${src||''}" alt="foto" ${!src ? 'style="background:#f0f0f0;min-height:90px;display:flex;align-items:center;justify-content:center" title="Vista previa no disponible"' : ''}>
            ${p.__local ? '<div class="local-icon">üì±</div>' : ''}
          </div>
          <input class="desc-input" type="text" placeholder="Descripci√≥n" value="${p.desc||''}" data-foto-id="${p.id_foto||p.id||p.localId||''}" />
          <div class="photo-row">
            <span class="badge ${p.__local?'warn':'ok'}">${p.__local?'Local':'Subida'}</span>
            ${!p.__local && p.url ? `<button class="btn-link" title="Abrir en Drive">üîó</button>` : ''}
          </div>
          <button title="Eliminar foto" class="btn-delete" aria-label="Eliminar foto">
            <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true"><path d="M6 7h12v12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2zM9 4h6l1 2H8l1-2zM10 9v8h2V9h-2zm4 0v8h2V9h-2z"/></svg>
          </button>
        `;
        const descInput = card.querySelector('input');
        const delBtn = card.querySelector('.btn-delete');
        const linkBtn = card.querySelector('.btn-link');
        
        descInput.addEventListener('input', ()=>{ p.desc = descInput.value; });
        delBtn.addEventListener('click', ()=>{
          __modalPhotos = __modalPhotos.filter(x=>x.localId!==p.localId);
          renderModalPhotos();
        });
        
        // Bot√≥n de enlace directo
        if (linkBtn && p.url) {
          linkBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            window.open(p.url, '_blank');
          });
        }
        wrap.appendChild(card);
      });
    }

    async function handleFilesSelected(files){
      for (const f of files){
        const previewUrl = URL.createObjectURL(f);
        __modalPhotos.push({
          localId: uid(),
          __local: true,
          __blob: f,
          previewUrl,
          url: null,
          desc: '',
          status: 'local',
          id_foto: null
        });
      }
      renderModalPhotos();
    }

    async function uploadOnePhoto(photo, id_trabajo){
      const fd = new FormData();
      fd.append('file', photo.__blob, `foto_${id_trabajo}_${Date.now()}.jpg`);
      fd.append('id_trabajo', id_trabajo);
      fd.append('descripcion_foto', photo.desc||'');
      
      console.log('üì∏ Uploading photo for trabajo:', id_trabajo, {
        description: photo.desc || '(empty)',
        hasBlob: !!photo.__blob,
        localId: photo.localId
      });
      
      const res = await fetch(ENDPOINT_UPLOAD, { method:'POST', body: fd });
      if(!res.ok) {
        const errorText = await res.text();
        console.error('Upload failed:', res.status, errorText);
        throw new Error(`Fallo al subir foto: ${res.status} - ${errorText}`);
      }
      
      const json = await res.json();
      console.log('Upload response full:', JSON.stringify(json, null, 2));
      
      // Buscar datos en diferentes niveles de anidaci√≥n
      const data = json.data || json;
      const remoteId = data.id_foto || data.id || data.fileId || json.id_foto || json.id || 
                      (json.response && json.response.id) || uid();
      const remoteUrl = data.url || data.webViewLink || data.webContentLink || data.fileUrl || 
                       data.link || json.url || json.webViewLink || json.fileUrl || 
                       (json.response && json.response.webViewLink) || null;
      
      photo.id_foto = remoteId;
      photo.url = remoteUrl;
      // Preservar la descripci√≥n que se envi√≥
      photo.descripcion_foto = photo.desc || '';
      
      if(photo.url) {
        photo.previewUrl = drivePreview(photo.url);
        console.log('‚úì Photo uploaded successfully:', {
          id: photo.id_foto,
          url: photo.url,
          preview: photo.previewUrl,
          description: photo.descripcion_foto
        });
      } else {
        console.warn('‚ö†Ô∏è Photo uploaded but no URL received:', json);
      }
      photo.__local = false;
      photo.__blob = null;
      photo.status = 'uploaded';
      return photo;
    }

    // Dependencia Lotes_Control -> Lotes_Trabajo
    function fillLoteTrabajoSelect(selectedTrabajoId){
      const controlId = $('#m_lote_control_id').value || '';
      const trabajos = (catalogos.lotes_trabajo||[]).filter(t => String(t.id_lote_control)===String(controlId));
      optionize($('#m_lote_trabajo_id'), trabajos, 'id', 'descripcion', {placeholder:'Seleccione frente espec√≠fico'});
      if (selectedTrabajoId) $('#m_lote_trabajo_id').value = selectedTrabajoId;
      markInvalid($('#m_lote_trabajo_id'), !$('#m_lote_trabajo_id').value);
    }

    // Localizaci√≥n (mostrar/ocultar campos)
    function updateLocControls(){
      const ab=$('#chk_abscisa').checked; const or=$('#chk_ordenada').checked; const el=$('#chk_elevacion').checked;
      const groups=[['loc-abscisa',ab,['m_abscisa_inicial','m_abscisa_final']],
                    ['loc-ordenada',or,['m_ordenada_inicial','m_ordenada_final']],
                    ['loc-elevacion',el,['m_elevacion_inicial','m_elevacion_final']]];
      for(const [cls,on,ids] of groups){
        $$('.'+cls).forEach(x=> x.classList.toggle('hidden', !on));
        if(!on){ ids.forEach(id=> { const el=$('#'+id); el.value=''; markInvalid(el,false); }); }
      }
    }

    // Estado actividad din√°mico
    function setEstadoActividadOptions(activity, presetValue){
      const sel = $('#m_estado_actividad');
      sel.innerHTML = '';
      const addOpt = (v, t) => { const o=document.createElement('option'); o.value=v; o.textContent=t; sel.appendChild(o); };

      if(activity === 'chequeo'){
        addOpt('n/a','N/A'); sel.value = 'n/a'; sel.disabled = true;
      } else if(activity === 'liberacion'){
        addOpt('cumple','Cumple'); addOpt('no_cumple','No cumple'); addOpt('otro','Otro');
        sel.disabled = false; if(presetValue) sel.value=presetValue; if(!sel.value) sel.value='cumple';
      } else { // levantamiento u otros
        addOpt('n/a','N/A'); sel.disabled = false; sel.value = presetValue || 'n/a';
      }
    }

    // Modal
    let modalMode='add'; let modalIndex=null;
    function openTrabajoModal(mode='add', index=null, data={}){
      modalMode=mode; modalIndex=index; $('#modalTitle').textContent = mode==='add'? 'Agregar trabajo' : 'Editar trabajo';
      if (!data.id) data.id = uid();
      $('#modalTitle').dataset.tid = data.id;

      // Contratista
      $('#m_contratista').value = data.contratista || '';

      // Lotes
      optionize($('#m_lote_control_id'), catalogos.lotes_control||[], 'id', 'nombre', {placeholder:'Seleccione lote'});
      const preCtrlId = data.lote_control_id || (catalogos.lotes_control||[]).find(lc => lc.nombre === data.lote_trabajo)?.id || '';
      $('#m_lote_control_id').value = preCtrlId || '';
      const preTrabajoId = data.lote_trabajo_id || (catalogos.lotes_trabajo||[]).find(lt => lt.descripcion === data.frente_especifico && String(lt.id_lote_control)===String(preCtrlId))?.id || '';
      fillLoteTrabajoSelect(preTrabajoId);

      // N√∫meros y textos
      $('#m_plano_construccion').value = data.plano_construccion||'';
      $('#m_abscisa_inicial').value = data.abscisa_inicial??''; $('#m_abscisa_final').value = data.abscisa_final??'';
      $('#m_ordenada_inicial').value = data.ordenada_inicial??''; $('#m_ordenada_final').value = data.ordenada_final??'';
      $('#m_elevacion_inicial').value = data.elevacion_inicial??''; $('#m_elevacion_final').value = data.elevacion_final??'';

      $('#m_actividad').value = data.actividad || ''; setEstadoActividadOptions($('#m_actividad').value, data.estado_actividad);
      $('#m_descripcion_actividad').value = data.descripcion_actividad||'';

      // Checks seg√∫n datos
      $('#chk_abscisa').checked = data.abscisa_inicial!=null || data.abscisa_final!=null;
      $('#chk_ordenada').checked = data.ordenada_inicial!=null || data.ordenada_final!=null;
      $('#chk_elevacion').checked = data.elevacion_inicial!=null || data.elevacion_final!=null;
      updateLocControls();

      // FOTOS (cargar existentes + limpiar previas locales)
      __modalPhotos = (data.fotos||[]).map(f=>({
        localId: uid(),
        __local: !f.url,           // si no tiene url, la trataremos como local (edge case)
        __blob: null,
        previewUrl: f.url ? drivePreview(f.url) : (f.previewUrl||''),
        url: f.url || null,
        desc: f.descripcion_foto||'',
        status: f.url ? 'uploaded' : 'local',
        id_foto: f.id || null
      }));
      renderModalPhotos();

      // limpiar errores previos
      $$('#modalBack input, #modalBack select, #modalBack textarea').forEach(el => markInvalid(el,false));

      $('#modalBack').style.display='flex'; document.body.classList.add('modal-open');
    }
    function closeTrabajoModal(){ $('#modalBack').style.display='none'; document.body.classList.remove('modal-open'); __modalPhotos = []; }

    function readTrabajoFromModal(){
      const useAb=$('#chk_abscisa').checked, useOr=$('#chk_ordenada').checked, useEl=$('#chk_elevacion').checked;
      const ctrlId = $('#m_lote_control_id').value || null;
      const trabId = $('#m_lote_trabajo_id').value || null;
      const ctrlName = findById(catalogos.lotes_control, ctrlId)?.nombre || '';
      const trabName = findById(catalogos.lotes_trabajo, trabId)?.descripcion || '';
      // Sincroniza descripciones antes de devolver el objeto
      __modalPhotos.forEach(f => { f.descripcion_foto = f.desc; });
      return {
        id: $('#modalTitle').dataset.tid || uid(),
        contratista: $('#m_contratista').value || '',
        lote_control_id: ctrlId, lote_trabajo_id: trabId,
        lote_trabajo: ctrlName, frente_especifico: trabName,
        plano_construccion: $('#m_plano_construccion').value.trim(),
        abscisa_inicial: useAb? numberOrNull($('#m_abscisa_inicial').value): null,
        abscisa_final:   useAb? numberOrNull($('#m_abscisa_final').value):   null,
        ordenada_inicial:useOr? numberOrNull($('#m_ordenada_inicial').value):null,
        ordenada_final:  useOr? numberOrNull($('#m_ordenada_final').value):  null,
        elevacion_inicial:useEl? numberOrNull($('#m_elevacion_inicial').value):null,
        elevacion_final:  useEl? numberOrNull($('#m_elevacion_final').value):  null,
        actividad: $('#m_actividad').value || '',
        descripcion_actividad: $('#m_descripcion_actividad').value.trim(),
        estado_actividad: $('#m_estado_actividad').value || 'n/a',
        estado:'activo',
        observaciones:'',
        // Mantener fotos (locales y subidas)
        fotos: __modalPhotos.map(p=>({
          id: p.id_foto || uid(),
          id_trabajo: $('#modalTitle').dataset.tid || null,
          desc: p.desc || '', // ‚Üê Copiar tambi√©n desc
          descripcion_foto: p.descripcion_foto || p.desc || '', // ‚Üê Usar desc como fallback
          url: p.url || null,
          __local: !!p.__local,
          __blob: p.__blob || null
        }))
      };
    }

    function addTrabajo(t){ if(!t.id) t.id=uid(); trabajosState.push(t); renderTrabajos(); }
    function updateTrabajo(i,t){ trabajosState[i]=t; renderTrabajos(); }
    function deleteTrabajoById(id){
      if(!confirm('¬øEliminar este trabajo?')) return;
      const idx = trabajosState.findIndex(x=>x.id===id);
      if(idx>-1){ trabajosState.splice(idx,1); renderTrabajos(); }
    }
    function limpiarTrabajos(){ trabajosState=[]; renderTrabajos(); }

    // Informes (listado y selects principales)
    function renderSelInforme(list){
      const sel=$('#selInforme');
      sel.innerHTML='';
      const ph=document.createElement('option'); ph.value=''; ph.textContent='‚Äî Selecciona / busca informe ‚Äî'; sel.appendChild(ph);
      for(const it of list){
        const op=document.createElement('option');
        op.value=it.id; op.textContent=`${it.fecha_informe||''} ‚Ä¢ ${it.frente||''} ‚Ä¢ ${it.jornada||''}`;
        sel.appendChild(op);
      }
    }

    function buildInformeObj(informeId){
      // Obtener valores de texto en lugar de IDs
      const equipoId = $('#equipo_trabajo_id').value;
      const topografoId = $('#topografo_id').value;
      
      const equipoText = equipoId ? findById(catalogos.equipos, equipoId)?.codigo_equipo || equipoId : null;
      const topografoText = topografoId ? findById(catalogos.personas, topografoId)?.nombre || topografoId : null;
      
      return {
        id: informeId,
        fecha_creacion: new Date().toISOString(),
        fecha_informe: $('#fecha_informe').value || todayISO(),
        jornada: $('#jornada').value,
        frente: $('#frente').value,
        clima: $('#clima').value,
        equipo_trabajo_id: equipoText,
        topografo_id: topografoText,
        observaciones: ''
      };
    }

    function fillForm(rec){
      currentId=rec?.id||null;
      $('#fecha_informe').value=rec?.fecha_informe||todayISO();
      $('#jornada').value=rec?.jornada||'diurno';
      $('#frente').value=rec?.frente||'Obras Principales';
      $('#clima').value=rec?.clima||'Seco';
      
      // Buscar IDs bas√°ndose en los valores de texto guardados
      const equipoId = rec?.equipo_trabajo_id ? 
        (catalogos.equipos||[]).find(e => e.codigo_equipo === rec.equipo_trabajo_id)?.id || rec.equipo_trabajo_id : '';
      const topografoId = rec?.topografo_id ? 
        (catalogos.personas||[]).find(p => p.nombre === rec.topografo_id)?.id || rec.topografo_id : '';
      
      $('#equipo_trabajo_id').value = equipoId;
      $('#topografo_id').value = topografoId;
      
      trabajosState=(rec?.trabajos||[]).map(x=> ({ id: x.id||uid(), ...x }));
      renderTrabajos();
      $('#btnEliminar').disabled=!currentId;
      $('#btnGenerarPDF').disabled=!currentId;
    }

    async function refreshCatalogs(){
      const out=await catalogsApi();
      catalogos = { ...catalogos, ...out };
      optionize($('#equipo_trabajo_id'), catalogos.equipos||[], 'id', 'codigo_equipo', {placeholder:'Seleccione equipo'});
      optionize($('#topografo_id'), catalogos.personas||[], 'id', 'nombre', {placeholder:'Seleccione top√≥grafo'});
      optionize($('#m_lote_control_id'), catalogos.lotes_control||[], 'id', 'nombre', {placeholder:'Seleccione lote'});
      fillLoteTrabajoSelect();
      toast('Listas actualizadas','ok');
    }

    async function bootstrap(){
      seed();
      $('#fecha_informe').value=todayISO();
      const out=await dataApi({action:'bootstrap'});
      await refreshCatalogs();
      renderSelInforme(out.informes||[]);
      updateConnStatus();
    }
    async function recargarInformes(){
      try {
        // Usar siempre localApi para obtener datos frescos del localStorage
        const out = await localApi({action:'list_informes'});
        renderSelInforme(out.informes||[]);
        
        // Limpiar la selecci√≥n actual si el informe ya no existe
        const currentSelection = $('#selInforme').value;
        if (currentSelection && !out.informes.find(inf => inf.id === currentSelection)) {
          $('#selInforme').value = '';
        }
      } catch (error) {
        console.error('Error recargando informes:', error);
        toast('Error al recargar lista de informes','danger');
      }
    }

    // Subida diferida: recorre todos los trabajos y sube fotos locales
    async function uploadPendingPhotos(informeId){
      if(!navigator.onLine) return;
      
      // Asegurar que todas las fotos tengan descripci√≥n actualizada
      for (const t of trabajosState) {
        if (t.fotos) {
          t.fotos.forEach(foto => {
            if (!foto.desc && !foto.descripcion_foto) {
              console.warn('‚ö†Ô∏è Foto sin descripci√≥n:', foto.localId || foto.id_foto);
              foto.desc = ''; // Asegurar que no sea undefined
              foto.descripcion_foto = '';
            } else if (foto.desc && !foto.descripcion_foto) {
              foto.descripcion_foto = foto.desc;
            }
          });
        }
      }
      
      let errores = [];
      for (const t of trabajosState) {
        if(!t.id) t.id = uid();
        const pending = (t.fotos||[]).filter(p=>p.__local && p.__blob);
        for (const p of pending) {
          try {
            // Log b√°sico de subida
            console.log('üìù Subiendo foto:', p.localId || p.id_foto);
            await uploadOnePhoto(p, t.id); // muta p con url e id
          } catch (e) {
            errores.push({trabajo: t.id, foto: p.localId, error: e.message});
          }
        }
      }
      if (errores.length) {
        console.error('‚ùå Errores al subir fotos:', errores);
        throw new Error('No se pudieron subir todas las fotos. Intenta de nuevo.');
      }
    }

    // Construye payload final sin campos internos (__blob, __local)
    function buildPayloadFinal(informeId){
      const informe = buildInformeObj(informeId);
      const trabajos = trabajosState.map(t => ({
        ...t,
        id: t.id || uid(),
        id_informe: informeId,
        fotos: (t.fotos||[])
          .filter(p => p.url || p.__local) // Solo incluir fotos con URL o pendientes
          .map(p => {
            const description = p.descripcion_foto || p.desc || '';
            console.log('üìã Mapping photo to payload:', p.id_foto || p.id);
            return {
              id: p.id_foto || p.id || uid(),
              id_trabajo: t.id,
              descripcion_foto: description,
              url: p.url || null,
              estado: p.url ? 'activo' : 'pendiente'
            };
          })
      }));
      
      console.log('Payload final:', JSON.stringify({informe, trabajos}, null, 2));
      return { informe, trabajos };
    }

    // Un solo bot√≥n: crea o actualiza (sube fotos primero)
    async function guardar(){
      if(!validateInforme()) return;

      const isUpdate = !!currentId;
      const preId = currentId || uid();

      console.log(`üîÑ Iniciando guardado de informe (${isUpdate ? 'actualizaci√≥n' : 'nuevo'}):`, preId);

      // Bloqueo b√°sico UI
      $('#btnGuardar').disabled = true;

      try{
        // 1) Sincronizar descripciones ANTES de subir fotos
        syncAllPhotoDescriptions();

        // 2) Subir fotos pendientes (si online)
        console.log('üîç Estado de trabajos antes de subir fotos:', trabajosState.map(t => ({
          id: t.id,
          fotos: (t.fotos || []).map(f => ({
            localId: f.localId,
            __local: f.__local,
            hasBlob: !!f.__blob,
            hasUrl: !!f.url,
            desc: f.desc || '(empty)'
          }))
        })));
        
        const totalPend = trabajosState.reduce((n,t)=>n + (t.fotos||[]).filter(p=>p.__local && p.__blob).length, 0);
        const totalPhotos = trabajosState.reduce((n,t)=>n + (t.fotos||[]).length, 0);
        
        console.log(`üì∏ Fotos pendientes: ${totalPend}, Total fotos: ${totalPhotos}`);
        
        if (totalPend > 0 && navigator.onLine) {
          toast(`Subiendo ${totalPend} foto(s)...`);
          console.log('üì§ Iniciando subida de fotos...');
          await uploadPendingPhotos(preId);
          console.log('‚úÖ Fotos subidas completamente');
        }

        // Validar que todas las fotos tengan URL antes de guardar
        const fotosSinUrl = trabajosState.flatMap(t => (t.fotos||[]).filter(p => !p.url));
        if (fotosSinUrl.length > 0) {
          console.error('‚ùå Hay fotos sin URL despu√©s de subir:', fotosSinUrl);
          toast('Error: Hay fotos que no se subieron correctamente. Intenta de nuevo.','danger');
          $('#btnGuardar').disabled = false;
          return;
        }

        // 2) Construir payload final y enviar a Sheets
        console.log('üìù Construyendo payload final...');
        const payload = buildPayloadFinal(preId);
        const action = isUpdate ? 'update_informe' : 'create_informe';
        
        console.log(`üåê Enviando a n8n (${action}):`, ENDPOINT_DATA);
        const response = await dataApi({ action, ...(isUpdate? {id:preId}:{}), data: payload });
        console.log('üì• Respuesta de n8n:', response);

        currentId = preId;
        mirrorLocal(payload);
        $('#btnEliminar').disabled = !currentId;
        $('#btnGenerarPDF').disabled = !currentId;
        await recargarInformes();
        
        console.log('‚úÖ Informe guardado exitosamente');
        toast(isUpdate? 'Actualizado':'Guardado','ok');
      }catch(e){
        console.error('‚ùå Error al guardar informe:', e);
        toast('Error al guardar: ' + e.message,'danger');
      }finally{
        $('#btnGuardar').disabled = false;
      }
    }

    async function eliminar(){
      if(!currentId) return;
      if(!confirm('¬øEliminar el informe actual?')) return;
      
      const informeIdAEliminar = currentId;
      
      try {
        await dataApi({action:'delete_informe', id: informeIdAEliminar});
        
        // Forzar eliminaci√≥n local tambi√©n
        const informes = db.get('informes',[]);
        const informesActualizados = informes.filter(x => x.id != informeIdAEliminar);
        db.set('informes', informesActualizados);
        db.del(`informe_${informeIdAEliminar}`);
        
        // Limpiar estado local
        currentId = null; 
        nuevo();
        
        // Recargar la lista de informes para reflejar el cambio
        await recargarInformes();
        
        toast('Informe eliminado correctamente','ok');
      } catch (error) {
        console.error('Error al eliminar informe:', error);
        toast('Error al eliminar informe: ' + error.message,'danger');
      }
    }

    async function generarPDF(){
      if(!currentId) return;
      
      $('#btnGenerarPDF').disabled = true;
      $('#btnGenerarPDF').textContent = 'Generando...';
      
      try {
        toast('Generando informe PDF...', 'info');
        
        const response = await fetch('https://luisyg.app.n8n.cloud/webhook/crear-pdf', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id_informe: currentId
          })
        });
        
        if (!response.ok) {
          throw new Error(`Error ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('üìÑ Respuesta del endpoint PDF:', result);
        
        // La respuesta es un array, tomar el primer elemento
        const pdfData = Array.isArray(result) ? result[0] : result;
        
        if (pdfData && pdfData.ok && pdfData.pdfUrl) {
          toast(`PDF generado: ${pdfData.pdfFileName || 'Informe.pdf'}`, 'ok');
          console.log(`üìÑ PDF creado - Filas: ${pdfData.rowsCreated}, Archivo: ${pdfData.pdfFileName}`);
          
          // Mostrar enlace al PDF en lugar de abrir ventana
          const pdfLink = document.getElementById('pdfLink');
          const pdfContainer = document.getElementById('pdfLinkContainer');
          pdfLink.href = pdfData.pdfUrl;
          pdfLink.textContent = pdfData.pdfFileName || 'Informe.pdf';
          pdfContainer.style.display = 'block';
        } else {
          throw new Error(pdfData?.message || 'Error al generar PDF - Respuesta inv√°lida');
        }
      } catch (error) {
        console.error('‚ùå Error generando PDF:', error);
        toast('Error al generar PDF: ' + error.message, 'danger');
      } finally {
        $('#btnGenerarPDF').disabled = false;
        $('#btnGenerarPDF').textContent = 'Generar Informe';
      }
    }

    function nuevo(){ 
      currentId=null; 
      fillForm({trabajos:[]}); 
      $('#selInforme').value=''; 
      $('#btnEliminar').disabled = true;
      $('#btnGenerarPDF').disabled = true;
      $('#pdfLinkContainer').style.display = 'none';
    }

    function updateConnStatus(){
      const txt=(navigator.onLine ? ((ENDPOINT_DATA||ENDPOINT_CATALOGS)? 'Online (endpoint)': 'Offline (sin endpoint)') : 'Offline');
      $('#statusChip').textContent=txt;
    }
    window.addEventListener('online', updateConnStatus);
    window.addEventListener('offline', updateConnStatus);

    // SW (v4) para evitar cache viejo
    if('serviceWorker' in navigator){
      const swCode = `const CACHE='topografia-cache-v4';
self.addEventListener('install', e=>{ self.skipWaiting(); e.waitUntil(caches.open(CACHE).then(c=>c.addAll([]))) });
self.addEventListener('activate', e=>{ clients.claim(); e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k))))) });
self.addEventListener('fetch', e=>{
  const req=e.request;
  if(req.mode==='navigate') { e.respondWith(fetch(req).catch(()=>caches.match(req))); return; }
  e.respondWith(caches.match(req).then(r=> r || fetch(req).then(res=>{ const cp=res.clone(); caches.open(CACHE).then(c=>c.put(req, cp)); return res; })));
});`;
      const blob=new Blob([swCode],{type:'text/javascript'});
      navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(()=>{});
    }

    /* ===== Testing Functions ===== */
    async function testEndpoints(){
      console.log('üß™ Testing endpoints...');
      
      // Test 1: Endpoint DATA
      try {
        const testRes1 = await fetch(ENDPOINT_DATA, {method: 'OPTIONS'});
        console.log('‚úÖ ENDPOINT_DATA accessible:', ENDPOINT_DATA, testRes1.status);
      } catch(e) {
        console.error('‚ùå ENDPOINT_DATA error:', e.message);
      }
      
      // Test 2: Endpoint UPLOAD
      try {
        const testRes2 = await fetch(ENDPOINT_UPLOAD, {method: 'OPTIONS'});
        console.log('‚úÖ ENDPOINT_UPLOAD accessible:', ENDPOINT_UPLOAD, testRes2.status);
      } catch(e) {
        console.error('‚ùå ENDPOINT_UPLOAD error:', e.message);
      }
      
      // Test 3: Endpoint CATALOGS
      try {
        const testRes3 = await fetch(ENDPOINT_CATALOGS, {method: 'GET'});
        console.log('‚úÖ ENDPOINT_CATALOGS accessible:', ENDPOINT_CATALOGS, testRes3.status);
      } catch(e) {
        console.error('‚ùå ENDPOINT_CATALOGS error:', e.message);
      }
    }
    
    // Ejecutar test en consola: testEndpoints()
    window.testEndpoints = testEndpoints;

    /* ===== Eventos UI ===== */
    $('#btnAddTrabajo').addEventListener('click', ()=> openTrabajoModal('add'));
    $('#btnCloseModal').addEventListener('click', closeTrabajoModal);
    $('#btnModalCancel').addEventListener('click', closeTrabajoModal);

    // Guardar trabajo con validaci√≥n (sin subir nada aqu√≠)
    $('#btnModalSave').addEventListener('click', ()=>{
      syncPhotoDescriptions();
      if(!validateTrabajoModal()) return;
      const t=readTrabajoFromModal();
      if(modalMode==='add') addTrabajo(t); else updateTrabajo(modalIndex, t);
      closeTrabajoModal();
    });

    // Validaci√≥n de campos obligatorios
    $('#m_contratista').addEventListener('change', ()=>{
      markInvalid($('#m_contratista'), !$('#m_contratista').value);
    });
    
    // Dependencia Lote Control -> Lote Trabajo
    $('#m_lote_control_id').addEventListener('change', ()=>{
      markInvalid($('#m_lote_control_id'), !$('#m_lote_control_id').value);
      fillLoteTrabajoSelect();
    });
    $('#m_lote_trabajo_id').addEventListener('change', ()=>{
      markInvalid($('#m_lote_trabajo_id'), !$('#m_lote_trabajo_id').value);
    });

    // Localizaci√≥n
    $('#chk_abscisa').addEventListener('change', updateLocControls);
    $('#chk_ordenada').addEventListener('change', updateLocControls);
    $('#chk_elevacion').addEventListener('change', updateLocControls);

    // Actividad ‚Üí Estado actividad din√°mico
    $('#m_actividad').addEventListener('change', ()=>{
      setEstadoActividadOptions($('#m_actividad').value, null);
      markInvalid($('#m_actividad'), !$('#m_actividad').value);
    });

    // Input de fotos (solo prepara previews y estado local)
    $('#m_fotos_input').addEventListener('change', (e)=>{
      const files = Array.from(e.target.files||[]);
      if(!files.length) return;
      handleFilesSelected(files).catch(err=>{
        console.error(err);
        toast('No se pudieron preparar las fotos','danger');
      });
      e.target.value = ''; // reset
    });

    // Otros botones
    $('#btnLimpiarTrabajos').addEventListener('click', ()=> limpiarTrabajos());
    $('#btnNuevo').addEventListener('click', nuevo);
    $('#btnGuardar').addEventListener('click', ()=> {
      syncPhotoDescriptions();
      guardar().catch(e=>{console.error(e); toast('Error al guardar','danger')});
    });
    $('#btnEliminar').addEventListener('click', ()=> eliminar().catch(e=>{console.error(e); toast('Error al eliminar','danger')}));
    $('#btnGenerarPDF').addEventListener('click', ()=> generarPDF().catch(e=>{console.error(e); toast('Error al generar PDF','danger')}));
    $('#btnSync').addEventListener('click', ()=> trySync().catch(e=>{console.error(e); toast('Error al sincronizar','danger')}));
    $('#btnRefreshCatalogs').addEventListener('click', ()=> refreshCatalogs().catch(e=>{console.error(e); toast('Error listas','danger')}));

    // Cerrar contenedor de enlace PDF
    $('#btnClosePdfLink').addEventListener('click', ()=> {
      $('#pdfLinkContainer').style.display = 'none';
    });

    $('#selInforme').addEventListener('change', async (e)=>{
      const id=e.target.value;
      if(!id){ nuevo(); return; }
      try{
        const {record}=await dataApi({action:'get_informe', id});
        fillForm(record);
      }catch(err){
        console.error(err); toast('No se pudo cargar','danger');
      }
    });

    // Arranque
    (async ()=>{ try{ await bootstrap(); }catch(err){ console.error(err); toast('No se pudo conectar','danger'); } })();

    // === Registro de SW (PWA) ===
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const reg = await navigator.serviceWorker.register('sw.js');
          console.log('[SW] registrado', reg.scope);
        } catch (e) {
          console.warn('[SW] no se pudo registrar', e);
        }
      });
    }

    // Auto-sync cortes√≠a al volver online
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible' && navigator.onLine) {
        if (typeof trySync === 'function') trySync().catch(()=>{});
      }
    });
    window.addEventListener('online', () => {
      if (typeof trySync === 'function') trySync().catch(()=>{});
    });

    // === Bot√≥n Instalar (opcional) ===
    let _deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      _deferredPrompt = e;
      const btn = document.getElementById('btnInstall');
      if (btn) btn.style.display = 'inline-flex';
    });
    document.getElementById('btnInstall')?.addEventListener('click', async () => {
      if (_deferredPrompt) {
        _deferredPrompt.prompt();
        const choice = await _deferredPrompt.userChoice;
        console.log('Instalaci√≥n:', choice.outcome);
        _deferredPrompt = null;
      }
    });
  </script>
</body>
</html>
